<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="JSamuel"><title>ctsdb | JSamuel&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"example.com",root:"/",language:"zh-CN",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!1},style:{primary_color:"#0066CC",avatar:"/images/avatar.svg",favicon:"/images/logo.svg",article_img_align:"left",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!1,scale:!1},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"Welcome to JSamuel's blog"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,trigger:"auto",unescape:!1,preload:!0},code_copy:{enable:!0,style:"default"},side_tools:{enable:!0},pjax:{enable:!1},lazyload:{enable:!1},version:"3.4.1"},KEEP.language_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 月前",year:"%s 年前"}</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">JSamuel&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">首页</a></li><li class="menu-item"><a href="/archives">归档</a></li><li class="menu-item"><a href="/categories">分类</a></li><li class="menu-item"><a href="/tags">标签</a></li><li class="menu-item"><a href="/changelog">更新日志</a></li><li class="menu-item"><a href="/about">关于</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">首页</a></li><li class="drawer-menu-item flex-center"><a href="/archives">归档</a></li><li class="drawer-menu-item flex-center"><a href="/categories">分类</a></li><li class="drawer-menu-item flex-center"><a href="/tags">标签</a></li><li class="drawer-menu-item flex-center"><a href="/changelog">更新日志</a></li><li class="drawer-menu-item flex-center"><a href="/about">关于</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ctsdb</span></div><div class="article-header"><div class="avatar"><img src="/images/avatar.svg"></div><div class="info"><div class="author"><span class="name">JSamuel</span> <span class="author-label">Lv3</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2021-11-13 21:20:37 </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/%E7%AD%94%E8%BE%A9/">答辩</a>&nbsp;</li><li>&gt; <a href="/categories/%E7%AD%94%E8%BE%A9/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/ctsdb/">ctsdb</a>&nbsp;</li><li>| <a href="/tags/big-data/">big-data</a>&nbsp;</li><li>| <a href="/tags/es/">es</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>1.8k 字</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>6 分钟</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h2 id="1-集群"><a href="#1-集群" class="headerlink" title="1. 集群"></a>1. 集群</h2><p>相同的集群名称 + 同网关下的机器，组成同一个集群<br>集群规模限制：集群状态信息，越大更新越慢，所以不能无限制的增大集群</p><h2 id="2-节点"><a href="#2-节点" class="headerlink" title="2. 节点"></a>2. 节点</h2><ul><li>master节点<ul><li>功能：<ul><li>选举</li><li>维护集群状态，分片分配等</li></ul></li></ul></li><li>data node</li><li>coordinating node</li></ul><h2 id="3-索引"><a href="#3-索引" class="headerlink" title="3. 索引"></a>3. 索引</h2><h3 id="（1）-拆分优点"><a href="#（1）-拆分优点" class="headerlink" title="（1） 拆分优点"></a>（1） 拆分优点</h3><ul><li>减少索引之间的相互影响：配置变更，不影响其他</li><li>分片数设置，与数据量达到平衡<ul><li>分片太多，拆成字写入/查询，拒绝率上升</li><li>分片太多，分段小，合并开销增加，小segment降低查询效率</li><li>分片太少，单个分片太大，数据倾斜，机器故障</li><li>分片太少，单个分片太大，需要过滤的数据增加</li></ul></li><li>自定义配置，适应不同的业务需求</li></ul><h3 id="（2）-拆分配置"><a href="#（2）-拆分配置" class="headerlink" title="（2） 拆分配置"></a>（2） 拆分配置</h3><ul><li>数据量较小的：3-5个分片，每个分片&lt;100G，2副本</li><li>数据量较大的：20-50G/分片，不超过50个分片</li></ul><h2 id="4-分片"><a href="#4-分片" class="headerlink" title="4. 分片"></a>4. 分片</h2><h3 id="（1）-作用"><a href="#（1）-作用" class="headerlink" title="（1） 作用"></a>（1） 作用</h3><ul><li>负载均衡</li><li>备份恢复迅速</li><li>分布式存储扩展，可伸缩性</li><li>提高查询并行度，提升读写性能</li></ul><h3 id="（2）-分配分片"><a href="#（2）-分配分片" class="headerlink" title="（2） 分配分片"></a>（2） 分配分片</h3><p>allocator（权重） + decider（配置规则）</p><ul><li>新建的索引：先主分片再副本分片<ul><li>找到权重最低的节点列表（分片数量最少的机器），递增排序（allocator）</li><li>一次遍历节点列表，判断是否需要分配（decider）</li></ul></li><li>rebalance超过阈值<ul><li>最不均衡索引，最先处理</li><li>比较不同节点上分片的权重，确定重新分片是否能改善</li></ul></li><li>权重计算<ul><li>分片weight：节点总分片 - 节点平均分片</li><li>索引weight：索引在节点上的分片 - 索引在节点上的平均分片</li><li>weight = 分片权重 * 分片weight + 索引权重 * 索引weight</li></ul></li><li>配置规则<ul><li>节点分片数限制 — 负载均衡</li><li>相同分片不在同一个节点 — 负载均衡</li><li>rebalance并发数 — 并发数量规范</li><li>recoverage并发数 — 并发数量规范</li><li>include/exclude配置 — 条件限制规则</li><li>磁盘空间阈值（最低，最高） — 条件限制规则</li></ul></li><li>rebalance触发<ul><li>weight &gt;= balance.threshold = 1.0</li></ul></li></ul><h3 id="3-文档写入哪个分片"><a href="#3-文档写入哪个分片" class="headerlink" title="(3) 文档写入哪个分片"></a>(3) 文档写入哪个分片</h3><p>routing（默认为id）<br>shard = hash（rounting） % number_of_primary_shards</p><h3 id="4-查询分片"><a href="#4-查询分片" class="headerlink" title="(4) 查询分片"></a>(4) 查询分片</h3><p>routing 或者是 过滤所有分片</p><h2 id="5-副本"><a href="#5-副本" class="headerlink" title="5. 副本"></a>5. 副本</h2><h3 id="（1）-作用-1"><a href="#（1）-作用-1" class="headerlink" title="（1） 作用"></a>（1） 作用</h3><ul><li>提高查询吞吐量，并发查询</li><li>高可用：保证数据完整性；节点异常恢复，副本分片提升为主分片</li><li>防止单点故障：主副本分片不能再同一个节点</li><li>容错：副本分片提升为主分片</li></ul><h3 id="（2）-IN-SYNC列表"><a href="#（2）-IN-SYNC列表" class="headerlink" title="（2） IN-SYNC列表"></a>（2） IN-SYNC列表</h3><ul><li>ES主节点维护，可供的分片副本列表</li><li>primary挂掉了，master从in-sync中选一个replica</li></ul><h3 id="（3）-数据一致性"><a href="#（3）-数据一致性" class="headerlink" title="（3） 数据一致性"></a>（3） 数据一致性</h3><ul><li>主/副写入成功：最终一致性，refresh前，短暂不一致</li><li>主写入失败：失败重试</li><li>备写入失败<ul><li>强一致：重试</li><li>非强一致：<ul><li>副本标记为不可用，不对外提供查询，后续恢复写入</li><li>更新节点信息前，短暂不一致</li></ul></li></ul></li><li>主副本写入成功，还未写入磁盘flush（1min）：translog + check point</li></ul><h3 id="（4）-数据恢复"><a href="#（4）-数据恢复" class="headerlink" title="（4） 数据恢复"></a>（4） 数据恢复</h3><p>translog + 数据备份</p><ul><li>recovery：translog<ul><li>主分片：translog</li><li>副分片：从主分片中拉取lucene分段（可跳过）和translog</li></ul></li><li>数据备份：HDFS</li></ul><h3 id="（5）-容错"><a href="#（5）-容错" class="headerlink" title="（5） 容错"></a>（5） 容错</h3><ul><li>master node宕机：自动master选举</li><li>replica容错<ul><li>master将replica提升为primary</li><li>master复制缺失的relica到节点上</li></ul></li></ul><h2 id="6，-选举"><a href="#6，-选举" class="headerlink" title="6， 选举"></a>6， 选举</h2><h3 id="（1）-master"><a href="#（1）-master" class="headerlink" title="（1） master"></a>（1） master</h3><ul><li>activeMaster列表：ping，过滤不通的，排除本地ip</li><li>Bully算法：参选人数过半 + 投票人数过半 + 优先级<ul><li>优先级：版本号 + id<ul><li>版本号越高，优先级越高</li><li>id越小，优先级越高</li></ul></li></ul></li><li>masterCandidate：配置<ul><li>集群状态版本编号 + 节点id</li></ul></li><li>探测到节点离开，若当前节点数不过半，则放弃master身份，重新加入集群，防止脑裂</li></ul><h3 id="（2）-集群元信息"><a href="#（2）-集群元信息" class="headerlink" title="（2） 集群元信息"></a>（2） 集群元信息</h3><ul><li>各节点上报元信息，根据版本号确定最新的元信息</li><li>参与选举的元信息要过关，master发布也要过半</li></ul><h3 id="（3）-主分片primary"><a href="#（3）-主分片primary" class="headerlink" title="（3） 主分片primary"></a>（3） 主分片primary</h3><p>master操作，选择集群元信息中“最新主分片列表”的最新分片（根据UUID）</p><h3 id="（4）-副本repllica"><a href="#（4）-副本repllica" class="headerlink" title="（4） 副本repllica"></a>（4） 副本repllica</h3><h2 id="7-Recovery"><a href="#7-Recovery" class="headerlink" title="7. Recovery"></a>7. Recovery</h2><h3 id="（1）-index-recovery"><a href="#（1）-index-recovery" class="headerlink" title="（1） index recovery"></a>（1） index recovery</h3><ul><li>分片分配成功后进入recovery</li><li>用于恢复数据<ul><li>主分片，数据未刷盘</li><li>副分片，数据未刷盘/副本未同步主</li></ul></li></ul><h3 id="（2）-主分片Recovery"><a href="#（2）-主分片Recovery" class="headerlink" title="（2） 主分片Recovery"></a>（2） 主分片Recovery</h3><p>重放translog</p><h3 id="（3）-副分片Recovery"><a href="#（3）-副分片Recovery" class="headerlink" title="（3） 副分片Recovery"></a>（3） 副分片Recovery</h3><ul><li>等主分片恢复之后再操作</li><li>恢复期间允许索引操作</li><li>数据一致性：版本号</li></ul><h2 id="8-集群数据"><a href="#8-集群数据" class="headerlink" title="8. 集群数据"></a>8. 集群数据</h2><h3 id="（1）-正排索引"><a href="#（1）-正排索引" class="headerlink" title="（1） 正排索引"></a>（1） 正排索引</h3><ul><li>优点：易维护</li><li>缺点：搜索代价大，耗时大</li><li>结构：id - 数据</li><li>作用：排序/聚合</li></ul><h3 id="（2）-倒排索引"><a href="#（2）-倒排索引" class="headerlink" title="（2） 倒排索引"></a>（2） 倒排索引</h3><ul><li>优点：搜索快</li><li>缺点：难维护</li><li>结构：term index - term dictionary - id list</li><li>作用：查询</li></ul><h3 id="（3）-doc-value"><a href="#（3）-doc-value" class="headerlink" title="（3） doc value"></a>（3） doc value</h3><ul><li>特点：序列化到磁盘，不支持analyzed</li><li>作用：排序，聚合</li></ul><h3 id="（4）-field-data"><a href="#（4）-field-data" class="headerlink" title="（4） field data"></a>（4） field data</h3><ul><li>特点：放在内存，JVM内存堆，支持analyzed</li><li>作用：排序，聚合</li></ul><h2 id="9-segment"><a href="#9-segment" class="headerlink" title="9. segment"></a>9. segment</h2><p>每个分片有多个segment，每个segment占用内存，文件句柄，文件</p><h3 id="（1）-refresh"><a href="#（1）-refresh" class="headerlink" title="（1） refresh"></a>（1） refresh</h3><p>index buffer -&gt; file system cache<br>1s/1次 -&gt; 10s/次</p><h3 id="（2）-flush"><a href="#（2）-flush" class="headerlink" title="（2） flush"></a>（2） flush</h3><p>file system -&gt; disk<br>30min/次，translog限制</p><h3 id="（3）-影响"><a href="#（3）-影响" class="headerlink" title="（3） 影响"></a>（3） 影响</h3><ul><li>内存：每个segment的cache内存，随着gc不会释放掉，过大过多的segment会导致系统运行没有内存，查询超时</li><li>数据查询：查询遍历每个segment，过多的segment导致查询速度变慢</li></ul><h3 id="（4）-优化措施：释放cache"><a href="#（4）-优化措施：释放cache" class="headerlink" title="（4） 优化措施：释放cache"></a>（4） 优化措施：释放cache</h3><ul><li>删除索引</li><li>force merge</li><li>关闭索引：文件在磁盘，释放内存</li></ul><h2 id="10-写入"><a href="#10-写入" class="headerlink" title="10. 写入"></a>10. 写入</h2><p>doc -&gt; translog<br>-&gt; disk (flush, 大小 &gt; 512M)<br>-&gt; index buffer<br>-&gt; file system cache (refresh, 1s/次)<br>-&gt; disk (flush, 30min/次)</p><ul><li>refresh<ul><li>open，可以被搜索</li><li>记录commit point</li></ul></li><li>flush<ul><li>持久化，删除translog</li><li>记录commit point到磁盘</li></ul></li></ul><h2 id="11-查询-检索"><a href="#11-查询-检索" class="headerlink" title="11. 查询/检索"></a>11. 查询/检索</h2><p>query then fetch<br>拆分到每一个分片：主/副本分片，随机轮询</p><h2 id="12-故障处理"><a href="#12-故障处理" class="headerlink" title="12. 故障处理"></a>12. 故障处理</h2><p>副本 + primary选举</p><h3 id="（1）-master-1"><a href="#（1）-master-1" class="headerlink" title="（1） master"></a>（1） master</h3><p>重新选举，Bully，投票</p><h3 id="（2）-primary"><a href="#（2）-primary" class="headerlink" title="（2） primary"></a>（2） primary</h3><p>master将In-sync列表中的Replica提升为primary<br>主分片选举，集群元信息记录的“最新主分片列表“（UUID）<br>数据恢复：translog</p><h3 id="（3）-replica"><a href="#（3）-replica" class="headerlink" title="（3） replica"></a>（3） replica</h3><p>master将这个node从In-sync中移除，在其他node启动shard<br>数据恢复：同步primary，primary segment + translog</p><h3 id="（4）-全部异常"><a href="#（4）-全部异常" class="headerlink" title="（4） 全部异常"></a>（4） 全部异常</h3><p>translog + 数据备份</p><h3 id="（5）-切换过程"><a href="#（5）-切换过程" class="headerlink" title="（5） 切换过程"></a>（5） 切换过程</h3><p>无感知，影响查询写入性能（重新分配分片，分片切换）</p><h2 id="13-查询分页方式"><a href="#13-查询分页方式" class="headerlink" title="13. 查询分页方式"></a>13. 查询分页方式</h2><h3 id="（1）-from-size"><a href="#（1）-from-size" class="headerlink" title="（1） from/size"></a>（1） from/size</h3><p>mysql类型，默认分页深度10000，超过报错</p><h3 id="（2）-search-after：实时请求下一页，不指定页数"><a href="#（2）-search-after：实时请求下一页，不指定页数" class="headerlink" title="（2） search after：实时请求下一页，不指定页数"></a>（2） search after：实时请求下一页，不指定页数</h3><p>利用上一次查询返回的游标，进行下一页查询<br>需要增加排序字段<br>开销小很多</p><h3 id="（3）-scroll-api：查询大量文档，实时性不高"><a href="#（3）-scroll-api：查询大量文档，实时性不高" class="headerlink" title="（3） scroll api：查询大量文档，实时性不高"></a>（3） scroll api：查询大量文档，实时性不高</h3><p>第一次查询时，生成快照，之后的每次翻页，都是基于这个快照的结果，不会查询到新数据<br>第一次查询，返回scroll id<br>每个查询都可以设置一个过期时间</p><h2 id="14-防止拖库"><a href="#14-防止拖库" class="headerlink" title="14. 防止拖库"></a>14. 防止拖库</h2><h3 id="（1）-CTSDB"><a href="#（1）-CTSDB" class="headerlink" title="（1） CTSDB"></a>（1） CTSDB</h3><ul><li>用户名密码 + VPV</li><li>其他人操作，需要授权</li></ul><h3 id="（2）接口层"><a href="#（2）接口层" class="headerlink" title="（2）接口层"></a>（2）接口层</h3><p>openapi</p><ul><li>限流</li><li>使用from + size，限制10000</li><li>鉴权，证书下发</li></ul><h3 id="（3）-逻辑层"><a href="#（3）-逻辑层" class="headerlink" title="（3） 逻辑层"></a>（3） 逻辑层</h3><ul><li>加密字段</li><li>密码加密 =》 字典攻击 =》 加盐</li></ul><h3 id="（4）-es"><a href="#（4）-es" class="headerlink" title="（4） es"></a>（4） es</h3><ul><li>身份认证：登录</li><li>传输加密：防抓包，启动TLS，TLS加密通信（证书）<ul><li>集群内部加密，TLS协议 + 证书</li><li>集群外部加密，https/ssl + 证书</li></ul></li><li>用户鉴权：角色，基于角色的访问控制</li><li>日志审计</li></ul><h2 id="15-其他"><a href="#15-其他" class="headerlink" title="15. 其他"></a>15. 其他</h2><p>add快，buld request慢 =》 可以增大并发，add操作不会被阻塞 =》 改成同步</p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li>本文标题：ctsdb</li><li>本文作者：JSamuel</li><li>创建时间：2021-11-13 21:20:37</li><li>本文链接：https://huiresurgeran.github.io/2021/11/13/ctsdb/</li><li>版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></div><div class="article-nav"><div class="article-next"><a class="next" rel="next" href="/2021/11/13/kafka/"><span class="title flex-center"><span class="post-nav-title-item">kafka</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comment-anchor"></div><div class="comment-area-title"><i class="fas fa-comments">&nbsp;评论</i></div><div class="valine-container"><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><div id="vcomments"></div><script>function loadValine(){new Valine({el:"#vcomments",appId:"G6kz5CJNepsTPKxWkd5BrvjG-gzGzoHsz",appKey:"p0E8ShCVi1HjKLHiXpS9dJIx",meta:["nick","mail","link"],avatar:"wavatar",enableQQ:!0,placeholder:"come on~",lang:"zh-CN".toLowerCase()});const l=setInterval(()=>{var e=document.querySelectorAll("#vcomments .vcards .vcard");if(0<e.length){var a,n="JSamuel";for(a of e){const t=a.querySelector(".vhead .vnick");var r=t.innerHTML;r===n&&(t.innerHTML=`${r} <span class="author">${function(e){switch(e){case"en":return"Author";case"zh-CN":return"博主";default:return"Master"}}(KEEP.hexo_config.language)}</span>`)}clearInterval(l)}else clearInterval(l)},2e3)}{const i=setTimeout(()=>{loadValine(),clearTimeout(i)},1e3)}</script></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">JSamuel</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">总访问量&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li><li class="go-comment"><i class="fas fa-comment"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item rss flex-center"><a class="flex-center" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%9B%86%E7%BE%A4"><span class="nav-number">1.</span> <span class="nav-text">1. 集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%8A%82%E7%82%B9"><span class="nav-number">2.</span> <span class="nav-text">2. 节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%B4%A2%E5%BC%95"><span class="nav-number">3.</span> <span class="nav-text">3. 索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-%E6%8B%86%E5%88%86%E4%BC%98%E7%82%B9"><span class="nav-number">3.1.</span> <span class="nav-text">（1） 拆分优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-%E6%8B%86%E5%88%86%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.</span> <span class="nav-text">（2） 拆分配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%86%E7%89%87"><span class="nav-number">4.</span> <span class="nav-text">4. 分片</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-%E4%BD%9C%E7%94%A8"><span class="nav-number">4.1.</span> <span class="nav-text">（1） 作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-%E5%88%86%E9%85%8D%E5%88%86%E7%89%87"><span class="nav-number">4.2.</span> <span class="nav-text">（2） 分配分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%96%87%E6%A1%A3%E5%86%99%E5%85%A5%E5%93%AA%E4%B8%AA%E5%88%86%E7%89%87"><span class="nav-number">4.3.</span> <span class="nav-text">(3) 文档写入哪个分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%89%87"><span class="nav-number">4.4.</span> <span class="nav-text">(4) 查询分片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%89%AF%E6%9C%AC"><span class="nav-number">5.</span> <span class="nav-text">5. 副本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-%E4%BD%9C%E7%94%A8-1"><span class="nav-number">5.1.</span> <span class="nav-text">（1） 作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-IN-SYNC%E5%88%97%E8%A1%A8"><span class="nav-number">5.2.</span> <span class="nav-text">（2） IN-SYNC列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">5.3.</span> <span class="nav-text">（3） 数据一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="nav-number">5.4.</span> <span class="nav-text">（4） 数据恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89-%E5%AE%B9%E9%94%99"><span class="nav-number">5.5.</span> <span class="nav-text">（5） 容错</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%EF%BC%8C-%E9%80%89%E4%B8%BE"><span class="nav-number">6.</span> <span class="nav-text">6， 选举</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-master"><span class="nav-number">6.1.</span> <span class="nav-text">（1） master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-%E9%9B%86%E7%BE%A4%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">6.2.</span> <span class="nav-text">（2） 集群元信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E4%B8%BB%E5%88%86%E7%89%87primary"><span class="nav-number">6.3.</span> <span class="nav-text">（3） 主分片primary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-%E5%89%AF%E6%9C%ACrepllica"><span class="nav-number">6.4.</span> <span class="nav-text">（4） 副本repllica</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Recovery"><span class="nav-number">7.</span> <span class="nav-text">7. Recovery</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-index-recovery"><span class="nav-number">7.1.</span> <span class="nav-text">（1） index recovery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-%E4%B8%BB%E5%88%86%E7%89%87Recovery"><span class="nav-number">7.2.</span> <span class="nav-text">（2） 主分片Recovery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E5%89%AF%E5%88%86%E7%89%87Recovery"><span class="nav-number">7.3.</span> <span class="nav-text">（3） 副分片Recovery</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%9B%86%E7%BE%A4%E6%95%B0%E6%8D%AE"><span class="nav-number">8.</span> <span class="nav-text">8. 集群数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">8.1.</span> <span class="nav-text">（1） 正排索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">8.2.</span> <span class="nav-text">（2） 倒排索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-doc-value"><span class="nav-number">8.3.</span> <span class="nav-text">（3） doc value</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-field-data"><span class="nav-number">8.4.</span> <span class="nav-text">（4） field data</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-segment"><span class="nav-number">9.</span> <span class="nav-text">9. segment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-refresh"><span class="nav-number">9.1.</span> <span class="nav-text">（1） refresh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-flush"><span class="nav-number">9.2.</span> <span class="nav-text">（2） flush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E5%BD%B1%E5%93%8D"><span class="nav-number">9.3.</span> <span class="nav-text">（3） 影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-%E4%BC%98%E5%8C%96%E6%8E%AA%E6%96%BD%EF%BC%9A%E9%87%8A%E6%94%BEcache"><span class="nav-number">9.4.</span> <span class="nav-text">（4） 优化措施：释放cache</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E5%86%99%E5%85%A5"><span class="nav-number">10.</span> <span class="nav-text">10. 写入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E6%9F%A5%E8%AF%A2-%E6%A3%80%E7%B4%A2"><span class="nav-number">11.</span> <span class="nav-text">11. 查询&#x2F;检索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="nav-number">12.</span> <span class="nav-text">12. 故障处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-master-1"><span class="nav-number">12.1.</span> <span class="nav-text">（1） master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-primary"><span class="nav-number">12.2.</span> <span class="nav-text">（2） primary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-replica"><span class="nav-number">12.3.</span> <span class="nav-text">（3） replica</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-%E5%85%A8%E9%83%A8%E5%BC%82%E5%B8%B8"><span class="nav-number">12.4.</span> <span class="nav-text">（4） 全部异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89-%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">12.5.</span> <span class="nav-text">（5） 切换过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-%E6%9F%A5%E8%AF%A2%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F"><span class="nav-number">13.</span> <span class="nav-text">13. 查询分页方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-from-size"><span class="nav-number">13.1.</span> <span class="nav-text">（1） from&#x2F;size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89-search-after%EF%BC%9A%E5%AE%9E%E6%97%B6%E8%AF%B7%E6%B1%82%E4%B8%8B%E4%B8%80%E9%A1%B5%EF%BC%8C%E4%B8%8D%E6%8C%87%E5%AE%9A%E9%A1%B5%E6%95%B0"><span class="nav-number">13.2.</span> <span class="nav-text">（2） search after：实时请求下一页，不指定页数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-scroll-api%EF%BC%9A%E6%9F%A5%E8%AF%A2%E5%A4%A7%E9%87%8F%E6%96%87%E6%A1%A3%EF%BC%8C%E5%AE%9E%E6%97%B6%E6%80%A7%E4%B8%8D%E9%AB%98"><span class="nav-number">13.3.</span> <span class="nav-text">（3） scroll api：查询大量文档，实时性不高</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-%E9%98%B2%E6%AD%A2%E6%8B%96%E5%BA%93"><span class="nav-number">14.</span> <span class="nav-text">14. 防止拖库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89-CTSDB"><span class="nav-number">14.1.</span> <span class="nav-text">（1） CTSDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%8E%A5%E5%8F%A3%E5%B1%82"><span class="nav-number">14.2.</span> <span class="nav-text">（2）接口层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E9%80%BB%E8%BE%91%E5%B1%82"><span class="nav-number">14.3.</span> <span class="nav-text">（3） 逻辑层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-es"><span class="nav-number">14.4.</span> <span class="nav-text">（4） es</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-%E5%85%B6%E4%BB%96"><span class="nav-number">15.</span> <span class="nav-text">15. 其他</span></a></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/code-copy.js"></script><div class="post-scripts"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.1/source/js/toc.js"></script></div></body></html>