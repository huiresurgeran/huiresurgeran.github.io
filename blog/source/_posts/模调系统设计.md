---
title: 模调系统配置
date: 2021-11-11 22:29:11
tags: [trace, config]
categories:
	- 答辩
	- 模调
---

## 1. kafka

### （1）副本数
3

### （2）分片
16

### （3）集群

- 深圳
	- 机型：kafka M10，zk M10
	- 机房：kafka JX，zk JX
	- 集群大小：16台
	- 域内域外：域外
- 上海
	- 机型：kafka M10，zk M10
	- 机房：kafka QP，zk QP
	- 集群大小：16台
	- 域内域外：域外
- 深圳通用
	- 机型：TS60
	- 机房：GM
	- 集群大小：
	- 域内域外：域外
	- 其他：无量
- 上海通用
	- 机型：TS60
	- 机房：QP
	- 集群大小：
	- 域内域外：域外
	- 其他：少量测试日志

### （4）ACK
1，leader返回ack，不等待其他broker

### （5）lag time
10s

### （6）同步数据时间
2s

### （7）监控
kafka manager

### （8）M10
2个12核的CPU
128G内存
300G磁盘（300*6 = 1800）
超线程 2 * 12 * 2 = 48核
计算类，实体机
网络类型，万兆

## 2. CTSDB

- 集群大小：24节点
- 机型：Y0-MI52-25G
- 机房：广州四区
- 机器配置：8核，40GB内存，2T存储
- 压测性能：96线程 + 60字段 + 并发5000，13W/s
- 副本：3副本
- 磁盘使用率：80%
- 分片分配权重：0.45f，0.55f，1.0
- 数据一致性：强一致
- 5000条，10M，10s，并行度1，重试3次，指数型，1s间隔

| | 处理 | 上报| 
| --- | --- | --- |
| 平均/天 | 80亿 | 66亿，1.5T | 
| 平均/h | 3.3亿 | 2.75亿 | 
| 平均/min | 556万 | 458万 | 
| 平均/s | 9.26万 | 7.64万 | 
| 峰值/min | 800万 | 600万 | 
| 峰值/s | 13.3万 | 10万 | 

压测数据
- 60字段
- 5000条数据一个批次
- 96并发线程
- 12.7W/s
- 0.28K/条数据

## 3. CKV+

- 版本：主从版
	- 主从：所有数据在同一台设备（不包含备份），适合业务数据量少的，命令更多
	- 集群：将数据散列到多台设备，适合业务增长快，体量大的
- 机房：JX + GM
- 副本：一主一备，每台机器一个分片
- 容量：70G
- 机型：B70 + CG3-10g
	- 万兆为主：M10，B70，CG1-10g
	- 不推荐使用虚拟机，影响性能
- 数据同步：异步
- 机器配置
	- 2w连接数
	- 单机2048连接数，最大空闲200

## 4. FMHA
- 集群大小：4台，一主三从
- 机房：SZ-JX，2台；LJ，1台；GM，1台
- 卡主修复：关闭
- 机型：Z4
- 复制类型：同步/半同步
- 容灾：强容灾
- 卡主阈值：24s
- 域内域外：域内
- 机器配置
	- 64GB内存
	- 300 * 2 = 600，300GB磁盘
	- Z4，用于给财付通存储数据

## 5. nginx
- 集群大小：5
- 机房：SZ-GM，1台；SZ-JX，2台；SH-BX，1台；SH-QP，1台
- 机型：V6-15-100
- 故障：重试4次，2s剔除，10s恢复
- 域内域外：域外
- 机器配置
	- 一个6核cpu
	- 14.4GB内存
	- 140GB磁盘
	- 网络类型，千兆
	- 虚拟机

## 6. server
- 集群大小：4
- 机房：SZ-GM，2台；SZ-JX，2台
- 机型：B6
- 故障
- 域内域外：域内
- 机器配置
	- 2个6核cpu
	- 64GB内存
	- 300GB硬盘
	- 适合中间层
	- 网络类型，千兆
	- 超线程，2*6*2 = 24核

## 7. log server
- 集群配置：6
- 机房：SZ-GM，3台；SZ-JX，3台
- 机型：B70
- 域内域外：域外
- 机器配置
	- 2个12核CPU
	- 128G内存
	- 300G磁盘
	- 超线程，2*12*2 = 48核
	- 网络，万兆
- CTSDB
	- 90线程/6台 = 15线程/台
	- Queue大小
- Processor篇日志
	- 高峰10W/s，25条/msgno =》 4000msgno/s
	- 时耗：拉取2-5ms + 处理10ms =》 15ms
	- 一个线程每秒处理多少个msgno：1000/15 = 67个
	- 4000/67 = 60个线程，60/6=10 线程/台
- Cacher配置
	- 70G大小，控制在30G左右，1.12亿数据量
	- 高峰期10-12W/s，每条写入时间1-2ms，每秒写入500-1000条数据
	- 12W/500=240线程，10W/1000=100线程
	- 6台服务器，240/6=40线程，100/6=17线程
	- 50核心线程，50最大，50队列
- kafka
	- 拉取
		- 自动提交：关闭，同步手动提交
		- 最大获取大小：0.5M =》 2M
		- 拉取批量大小：5000
		- session超时：10000ms
		- 心跳上报间隔：1000ms = 1s
		- offset获取：earliest
		- 写入Queue间隔：5000ms = 5s
		- 拉取数据线程数：2（运营平台） / 5（计算）
		- 载入配额：60000
		- 失败重试，加载延迟：1000ms
	- 处理
		- 处理线程数：32（运营） =》 30
		- 写入Queue间隔：60000ms = 60s
		- 批次大小：3000 =》 5000
		- Queue长度：32 =》 30
	- 写入
		- 限速开关：打开
		- 写入es集群间隔：60000ms = 60s
		- 写入es批次：3000 =》 5000
		- 写入线程数：8 =》 15
		- 限速：20000/s =》 5000/s
		- 重试次数：3次 =》 丢失
		- Queue长度：32 =》 30
	- 限速处理（蓄水池，熔断）
		- 熔断，失败率：80%
		- 打开 -》 半打开，等待时间：300s
		- 关闭状态下RF大小：500
		- 半打开状态小RF大小：20
		- 写入失败，sleep，重试，大于5次，丢失
- BlockingQueue
	- 12.7W/s，字段多，考虑减少
	- 副本，强一致
	- 5000/线程
	- 使用RateLimiter


