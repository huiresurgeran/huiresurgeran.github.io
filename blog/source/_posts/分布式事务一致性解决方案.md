---
title: 分布式事务一致性解决方案
date: 2021-11-10 21:46:53
tags: [distributed computing]
categories:
	- 答辩
	- 分布式事务
---

## 1. 数据一致性
主库、从库、缓存数据一致性
多副本数据一致性
分布式服务的数据一致性

## 2. 概念
强一致性
弱一致性
最终一致性

## 3. 原理
- 事务的ACID特性
	- 原子性（Atomicity）
	- 一致性（Consistency）
	- 隔离性（Isolation）
	- 持久性（Durability）
- CAP定理，无法同时满足
	- Consistency，一致性
	- Availability，可用性
	- Partition tolerance，分区容错性
- BASE理论：BASE 理论是针对 NoSQL 数据库而言的，它是对 CAP 理论中一致性（C）和可用性（A）进行权衡的结果
	- 基本可用（Basically Available）
	- 软状态（Soft-state）
	- 最终一致性（Eventually Consistent）

## 4. 协议
- 两阶段提交
- 三阶段提交
- TCC
- Paxos
- ZAB：zk使用
- Raft：先选出主节点
- Quorum
- Gossip

## 5. 强一致性方案

### （1）2PC，二阶段提交协议
- 阶段一：Prepare，准备，投票
- 阶段二：Commit/Cancel，提交，回滚
缺点：阻塞范围广，不适合高并发场景

### （2）DTP/XA规范
- AP：应用程序
- RMS：资源管理器，参与者
- TM：事务管理器，协调者
- XA：组件之间香菇操作的接口

## 6. 最终一致性方案

### （1）TCC
- T：try，锁定资源
- C：Confirm，确认，补偿
- C：Cancel
阻塞时间范围短，性能比2PC有提升

### （2）本地事务状态表
调用方调用分布式事务之前，将待执行的事务流程和状态信息，存储到数据库中，之后每次调用成功，更新对应的事务状态，失败则终止

### （3）消息中间件
- 消息中间件，不支持事务
- 消息中间件，支持事务：定时任务的工作交给消息中间件来提供

## 7. 弱一致性方案

### （1）基于状态的补偿
事后处理机制

### （2）重试（+回滚） + 告警 + 人工修复
放弃一致性
成本最低，最被动

### （3）事后处理
对账

## 7. 结论
数据一致性要求高：金融银行，2PC，强一致性方案
可用性 + 一致性：互联网应用，Base理论，最终一致性
极端场景：业务特性，弱一致性
