---
title: 模调系统
date: 2021-11-10 13:08:51
tags: [trace]
categories:
	- 答辩
	- 模调
---

## 1. 系统要求

#### （1）逻辑耦合低
- 拆分成五个模块
- 各模块单独配置

#### （2）可维护性强
- 每个模块调整，不影响其他模块
- 接入监控，可以看到每个模块的处理状态

#### （3）可扩展性高
- 数据拉去：支持配置多个kafka集群
- 数据处理
	- 通过filter，增加处理流程
	- 不规范裁剪 + 特殊处理 + IP补充 + 其他
- 数据缓存
	- 通过规则放到不同的列表中
	- IP + msgno尾号
- 数据拉取计算
	- 可配置不同的算法
	- 找FCGI入口 + 计算调用树
- 数据写入：支持写入多个集群

## 2. 容量

#### （1）应用服务器

| | 前端 | 后台 | writer | openapi |
| ---- | ---- | ---- | ---- | ---- |
| 每天请求量| 400 | 400 | | 4863 |
| 各接口访问峰值 | 15/min | 15/min | | 161/min |
| 平均请求响应 | 0 | 0 | | 65ms |
| 最大请求响应 | 0 | 0 | | 61621ms |
| 网卡I/O流量 | | | 入49.5/min，91.5/min；出56.2/min，106.8/min | |
| 磁盘I/O负载 | | | 读平均：0，写平均：5611，写峰值：7961 | |
| 内存使用情况 | 平均12.7，峰值14.4 | | 平均54，峰值57.2| |
| CPU使用情况 | 平均3，峰值11 | | 平均33，峰值40 | |

#### （2）数据库

| | FMHA | CTSDB |
| ---- | ---- | ---- |
| 当前数据容量 | 50-60G | 3T * 7 =21T，470亿 |
| 每天数据增量 |  | 1.5T * 2 = 3T，66亿| 
| 读峰值/s | 494 | 11/min，2/s |
| 写峰值/s | 290 | 10.7w / min | 

#### （3）缓存
| | CKV+ | 
| ---- | ---- |
| 缓存内容大小 | 15-20G |
| 缓存内容数量 | |
| 缓存过期时间 | 30min/24h |
| 缓存数据结构 | list，set |
| 读峰值/s | 7985253/min，13.3w/s |
| 写峰值/s | 7985253/min，13.3w/s |
| 连接数限制 | 2w |
| 备shard | 不可读，1副本 |

#### （4）消息队列
| | kafka |
| ---- | ---- |
| 每天平均数据增量 | 80亿 |
| 消息持久的过期时间 | 3天 |
| 读峰值/s | |
| 写峰值/s | |
| 每条消息大小 | 0.14k |
| 平均延迟 | |
| 最大延迟 | |

## 3. 容错
发生故障时，系统还能继续运行

## 4. 可伸缩性
kafka：增加分片，broker进入/退出
writer：增加进程，提高模块线程数，限速
CTSDB：增加副本，node进入/退出

## 5. 性能

#### （1）性能测试
响应时间 + 并发数 + 吞吐量
吞吐量 = （ 1000 / 响应时间ms ) * 并发数

#### （2）影响性能因素

##### 硬盘
- cpu：48核 =》 线程数
- 内存：128G
- 磁盘IO
- 网络

##### 软件
- 数据库
	- 内存，CPU计算，磁盘读写
	- 可以改为使用缓存
- 锁竞争
	- 上下文切换，性能开销
	- 请求堆积，影响性能
- 异常：异常抛出需要构建异常栈，捕获和处理，消耗系统性能

#### （3） 优化策略
- 优化代码：数据结构；设计；算法；空间换时间
- 参数调优：JVM，线程池，连接池
- 硬盘：合理设置线程数
- 软件：缓存，减少锁
- 兜底：限流，降级，熔断

#### （4）实际

##### 拉取
- api升级
	- 批量拉取，提高并发
	- 心跳线程，防止频繁rebalance
	- 批次，批量大小
	- offset存在zk，改为，offset存在topic，提高性能
- 限流：设定限额，根据CTSDB处理能力
- 熔断：queue写入失败，熔断器

##### 处理
- 线程分配
- 缓存，减少db压力

##### 缓存
- 线程池
- 连接池

##### 计算
- 连接池
- 去掉加锁，列表拆分

##### 写入
- 批量写入
- 一边累计，一边发送，并发度
- 限流：令牌桶

##### 其他
- 令牌桶，限流
- 超过，考虑增加熔断器，蓄水池等等