---
title: 容灾和数据一致性
date: 2021-11-10 21:53:45
tags: [disaster tolerance]
categories:
	- 答辩
	- 容灾
---

## 1. 成果

### （1）服务部署层面
服务的多活部署，拥有容灾能力

### （2）低成本容灾
ng/svr多园区部署
L5剔除
单机故障演戏

### （3）高成本的未做
CTSDB/CKV+，外部门，演戏成本高

### （4）无上海机房
中心设备分布决定
满足了深圳多园区的容灾要求

### （5）FMHA
只存储配置相关的数据，要求不高

### （6）CTSDB/CKV+
多园区容灾部署
成本考虑

## 2. 域名解析
DNS解析服务：机器故障，5min剔除，慢

## 3. TGW

### （1）自己
一个集群4台TGW，每台TGW与其他三台TGW实时同步会话信息

### （2）下游服务
周期性探测server的状态，1min
从客服务列表中剔除故障server
检测服务恢复正常，自动加回可服务列表


## 4. 智能网关
多集群部署

### （1）容灾

#### 自己
多园区部署
深圳主集群，天津灾备

#### 下游服务
- 心跳检测机制
- 同一个进程，三次发送到同一个IP的请求均连接失败，就踢掉该IP，请求不会发送到故障服务器
- 智能路由转发

### （2）其他功能
- TOF统一身份认证
- 鉴权，员工身份信息
- 共享登录态
- 智能路由转发

## 5. nginx
两地四中心 + 智能网关心跳检测

### （1）上游
智能网关

### （2）自己
多园区部署，多城市部署

### （3）下游
- 异常重试：4次，服务器列表根据权重轮询
- 停止重试：请求时间60S/重试次数4次
- 踢掉策略：超时2s，认为失败，踢掉
- 恢复策略：屏蔽10s，重新加入存活服务器列表

## 6. 权限系统
降级登录（探测OA，302次数超过阈值）
智能网关开启免登陆

## 7. 北极星

## 8. L5

### （1）容灾

#### 自己
agent挂了，从文件中读取路由信息

#### 下游
- 故障剔除：连续上报10次失败 / 1min失败>50%
- 故障恢复：每10s对网络层探测，ok则逐步放量请求

### （2）其他功能
- 负载均衡：空闲状态
- 过载保护：回包状态 =》 一个周期内不给服务提供者分配请求
- 路由策略：配置 + 权重 + 轮询
- 全部服务过载，降级，一个周期内不再返回可用路由

## 9. CL5

### （1）容灾

#### 故障剔除
一个周期内，错误率大于某个阈值，或者连续错误多少次，节点故障

#### 故障恢复
ping探测宕机节点
连通，放少量流量，后逐渐恢复正常

### （2）其他功能
- 负载均衡：静态权重（配置） + 动态权重（成功率，耗时）
- 过载保护：降级

## 10. openapi/oms网关
oms网关：多集群部署 + L5切换
openapi：两地四中心 + oms网关全量信息

### （1）网关
- 网关集群：L5切换
- 网关子服务：
	- 每套网关多台服务器
	- 每个网关机器都有全量子服务信息

### （2）服务端
- 服务注册
	- 保存服务信息到本地
	- 同步协议，同步服务信息到其他网关机器
	- 子服务从网关同步到其他子服务
- 心跳检测
	- 网关定时检测子服务心跳，剔除无心跳服务
	- 子服务定期发送心跳
- 客户端缓存

## 11. 日志写入服务
两地两中心 + 消费者组机制

异常重试：CTSDB
容灾：消费者组，rebalance

## 12. 日志查询服务
两地四中心 + nginx配置（故障剔除）

异常重试：nginx，4次
容灾：
- 故障剔除：2s，1次
- 故障恢复：10s

## 13. CTSDB
支持多地域部署 + 多副本 + 选举

### （1）容灾
- 集群：多园区容灾
- 城市：不同地域相互隔离，多园区
- 机房：多可用区部署
- 单台机器：
	- master：选举，投票（id排序，Bully算法）
	- primary：副本 + 选举
		- 动态更新 =》 IS列表 =》 master将服务提升为primary（最新的UUID）
		- master复制一个副本，分配在节点
	- replica：同上

### （2）数据一致性
- 主副本分片：强一致
- 写入，主副本都失败，重试
- 写入，主成功，备失败
	- 强一致：失败，重试
	- 非强一致：
		- 副本故障，移除in-sync
		- 不对外提供查询，后续异步恢复
		- master分配新的副本
		- IS存在集群元信息中，master维护
		- 写入副本失败，从IS中剔除，动态更新IS列表
- 写入，主备都成功，成功

### （3）返回成功，数据没有flush到磁盘
translog（日志文件） + commit point

### （4） 全部失败
备份，快照

## 14. FMHA
一地三中心 + 半同步 + 主备切换 + CTSDB

### （1）容灾

- 跨城：名字服务DNS + agent上报心跳
- 跨IDC：权重 + 名字服务DNS + agent上报心跳
- 跨机：
	- 主从切换，权重 + gtid（Global Transaction Identifier，一个事务对应一个GTID，全局唯一）
	- 数据同步 + 切换
	- 半同步复制

### （2）数据一致性
三园区 + 半同步 + GTID + read_only

### （3）卡主
关闭：主备切换

## 15. TDW
多园区容灾 + 自动恢复 + 任务迁移

## 16. CKV+
支持多集群部署 + L5切换 + 分片副本 + 主备切换

### （1）容灾
副本 + 选举（默认一主一备）
副本：默认跨机架，也可跨城

- 客户端L5，自动剔除
- 集群，跨IDC部署
- 城市，跨城部署
- 多机器故障：主备分片同时异常，无法切换
	- 设备可恢复：本地快照 + 流水
	- 设备不可恢复：冷备文件回档（每天至少一次冷备，保存三天）
- 单机器故障
	- 故障检测：master发送心跳，2s间隔，10次四百
	- 设备异常，不可恢复，分片，30s内完成
		- 主分片，主备切换
		- 备份片，重建
	- 设备异常，可恢复
		- 秒级恢复，共享内存
		- 分片状态正常，无操作
		- 分片状态修改中，异常
			- 主分片：剔除主，主备切换
			- 备份片：剔除备，新建备

### （2）数据一致性
异步（默认），强一致（Raft协议，性能损耗大）

- 写入
	- 主备成功：一致
	- 主挂了：剔除主，主备切换（数据未同步，丢失）
	- 备挂了：剔除备，换备
	- 主备失败：重试
- 复制中主挂了
	- 可恢复：秒级恢复
	- 不可恢复： 数据丢失

### （3） 选举

- master
	- 3个节点，不同机房
	- 创建key，成功则为master
	- 节点异常，TTL到期，其他Follower抢占

## 17. kafka
多集群部署（两地两中心） + 多副本 + 选举

### （1）容灾
副本 + 选举

- controller：zk，创建节点
- leader：controller提升副本 + ISR列表（leader维护，zk中也有） + 第一个
- follower：再分配follower

### （2）数据一致性
- leader失败：重试
- leader成功，fowller失败：异步 + 重试 + ISR

## 18. 集群/set化作用
- 流量拆分
- 故障隔离
- 异地容灾
